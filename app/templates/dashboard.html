<!-- templates/dashboard.html -->

{% extends "app.html" %}

{% set navbar_size = 'small' %}

{% block title %}
    {{ super() }} - Dashboard de {{ current_user.username }}
{% endblock %}
</div>
{% block head %}
    <!-- Incluir la meta tag para el token CSRF -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {{ super() }}
{% endblock %}

{% block content %}
{% if not current_user.is_authorized %}
    <div class="container mt-5">
        <div class="alert alert-danger text-center" role="alert">
            <h4 class="alert-heading">Acceso No Autorizado</h4>
            <p>Tu cuenta no está autorizada para acceder a esta página.</p>
            <hr>
            <p class="mb-0">Por favor, contacta con el administrador para solicitar autorización.</p>
        </div>
    </div>
{% else %}
    <!-- Contenedor Principal -->
    <div class="container-fluid d-flex flex-grow-1" style="padding-top: 3rem;">
    <div class="row flex-fill">
        <!-- Sidebar Izquierdo -->
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse h-100" style="padding-top: 5rem;">
            <div class="position-sticky pt-3 h-100">
                <div class="text-center mb-2">
                    {% if current_user.profile_image %}
                        <img src="{{ url_for('static', filename='img/profile_pics/' ~ current_user.profile_image) }}" alt="{{ current_user.username }}'s Profile Picture" class="profile-picture img-thumbnail" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#changeProfilePicModal">
                    {% else %}
                        <img src="{{ url_for('static', filename='img/profile_pics/default.jpg') }}" alt="Default Profile Picture" class="profile-picture img-thumbnail">
                    {% endif %}
                </div>
                <h4 class="text-center mb-2">{{ current_user.username }}</h4>
                <p class="text-center mb-2"><small>{{ current_user.bio }}</small></p>
                <hr>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#" data-section="linktreeSection">
                            <i class="fas fa-link me-1"></i>
                            Linktree
                        </a>
                    </li>
                    <div class="separator my-2"></div>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="analyticsSection">
                            <i class="fas fa-chart-line me-2"></i>
                            Analytics
                        </a>
                    </li>
                    <hr>
                    <li class="nav-item mt-2">
                        <button class="btn btn-sm btn-dashboard w-100 mb-2" data-bs-toggle="modal" data-bs-target="#customizeModal">
                            <i class="fas fa-paint-brush me-2"></i>
                            Personalizar Fondo
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-sm btn-dashboard w-100 mb-2" data-bs-toggle="modal" data-bs-target="#editBioModal">
                            <i class="fas fa-user-edit me-2"></i>
                            Editar Biografía
                        </button>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('user_links_page', username=current_user.username) }}" class="btn btn-sm btn-dashboard w-100 mb-3">
                            <i class="fas fa-eye me-2"></i>
                            Ver Perfil Público
                        </a>
                    </li>
                    <li class="nav-item">
                        <div class="social-share-buttons text-center">
                            <span>Compartir Perfil:</span>
                            <div class="d-flex justify-content-center mt-2">
                                <a href="https://facebook.com/sharer/sharer.php?u={{ url_for('user_links_page', username=current_user.username, _external=True) }}" target="_blank" class="btn btn-sm btn-facebook me-2">
                                    <i class="fa-brands fa-square-facebook"></i>
                                </a>
                                <a href="https://twitter.com/intent/tweet?url={{ url_for('user_links_page', username=current_user.username, _external=True) }}&text=Visita mi Linktree!" target="_blank" class="btn btn-sm btn-twitter me-2">
                                    <i class="fa-brands fa-twitter"></i>
                                </a>
                                <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ url_for('user_links_page', username=current_user.username, _external=True) }}" target="_blank" class="btn btn-sm btn-linkedin me-2">
                                    <i class="fa-brands fa-linkedin-in"></i>
                                </a>
                                <a href="https://www.instagram.com/sharer.php?u={{ url_for('user_links_page', username=current_user.username, _external=True) }}" target="_blank" class="btn btn-sm btn-instagram">
                                    <i class="fa-brands fa-square-instagram"></i>
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Sección de Linktree -->
            <div id="linktreeSection">
                <h2 class="mt-4 mb-4">Gestionar Linktree</h2>
                <div class="row">
                    <!-- Panel de Gestión de Enlaces -->
                    <div class="col-md-6">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                <span>Enlaces</span>
                                <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addLinkModal">
                                    <i class="fas fa-plus"></i> Agregar Enlace
                                </button>
                            </div>
                            <div class="card-body">
                                {% if links %}
                                    <ul id="sortable" class="list-group">
                                        {% for link in links %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ link.id }}">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-arrows-alt handle me-3 text-muted" style="cursor: move;"></i>
                                                <i class="{{ link.icon or 'fas fa-link' }} me-2"></i>
                                                <div>
                                                    <strong>{{ link.title }}</strong>
                                                    <br>
                                                    <a href="{{ link.url }}" target="_blank">{{ link.url }}</a>
                                                </div>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editLinkModal"
                                                    data-link-id="{{ link.id }}"
                                                    data-link-title="{{ link.title|e }}"
                                                    data-link-url="{{ link.url|e }}"
                                                    data-link-icon="{{ link.icon|e }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete('{{ link.id|safe }}')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No has agregado ningún enlace aún.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Previsualización en Teléfono -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="phone-preview d-flex justify-content-center">
                                    <div class="phone">
                                        <div class="screen" id="phoneScreen">
                                            <!-- Fondo dentro del teléfono -->
                                            {% if current_user.background_type == 'video' and current_user.background_video and current_user.background_video.endswith(('.mp4', '.mov', '.avi')) %}
                                            <video class="phone-background-media" autoplay loop muted>
                                                <source src="{{ url_for('static', filename='video/backgrounds/' ~ current_user.background_video) }}" type="video/mp4">
                                                Tu navegador no soporta videos.
                                            </video>
                                            {% elif current_user.background_type == 'image' and current_user.background_image and current_user.background_image.endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
                                            <img src="{{ url_for('static', filename='img/backgrounds/' ~ current_user.background_image) }}" alt="Background Image" class="phone-background-media">
                                            {% else %}
                                            <div class="phone-background-placeholder"></div>
                                            {% endif %}
                                            
                                            <!-- Enlaces en la previsualización (iframe) -->
                                            <iframe src="{{ url_for('user_links_page', username=current_user.username) }}" class="linktree-iframe" frameborder="0" allowfullscreen></iframe>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Analytics Mejorada -->
            <div id="analyticsSection" class="d-none">
                <h2 class="mt-4 mb-4">Analytics de Linktree</h2>
                <div class="row">
                    <!-- Gráfico de Clics por Enlace -->
                    <div class="col-md-6">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-info text-white">
                                Clics por Enlace
                            </div>
                            <div class="card-body">
                                <canvas id="clicksChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Gráfico de Enlaces Más Populares -->
                    <div class="col-md-6">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-warning text-white">
                                Enlaces Más Populares
                            </div>
                            <div class="card-body">
                                <canvas id="popularLinksChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <!-- Nueva Gráfica de Tendencias de Clics -->
                    <div class="col-md-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-success text-white">
                                Tendencia de Clics a lo Largo del Tiempo
                            </div>
                            <div class="card-body">
                                <canvas id="trendClicksChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modales -->

        <!-- Modal para Agregar Enlace -->
        <div class="modal fade" id="addLinkModal" tabindex="-1" aria-labelledby="addLinkModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="addLinkForm" method="POST" action="{{ url_for('add_link_ajax') }}" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addLinkModalLabel">Agregar Nuevo Enlace</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campos del formulario con Validación en Tiempo Real -->
                            <div class="mb-3">
                                <label for="title" class="form-label">Título <span class="text-danger">*</span></label>
                                <input type="text" name="title" id="title" class="form-control" required>
                                <div class="invalid-feedback">
                                    Por favor, ingresa un título.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="url" class="form-label">URL <span class="text-danger">*</span></label>
                                <input type="url" name="url" id="url" class="form-control" required>
                                <div class="invalid-feedback">
                                    Por favor, ingresa una URL válida.
                                </div>
                            </div>
                            <!-- Selección de Icono -->
                            <div class="mb-3">
                                <label class="form-label">Selecciona un Icono <span class="text-danger">*</span></label>
                                <div class="row" id="iconPicker">
                                    <!-- Iconos de FontAwesome -->
                                    {% for icon in [
                                        'fab fa-youtube', 'fab fa-twitter', 'fab fa-facebook', 'fab fa-instagram',
                                        'fab fa-linkedin', 'fab fa-snapchat', 'fab fa-whatsapp', 'fab fa-pinterest',
                                        'fab fa-reddit', 'fab fa-tiktok', 'fab fa-spotify', 'fab fa-discord',
                                        'fab fa-github', 'fab fa-stack-overflow', 'fab fa-apple', 'fab fa-android',
                                        'fab fa-aws', 'fab fa-dropbox', 'fab fa-paypal', 'fab fa-soundcloud'
                                    ] %}
                                    <div class="col-3 col-sm-2 mb-3">
                                        <button type="button" class="btn btn-light icon-btn" data-icon="{{ icon }}" title="{{ icon.split(' ')[1].replace('-', ' ') | capitalize }}">
                                            <i class="{{ icon }} fa-2x"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <!-- Campo Oculto para el Icono Seleccionado -->
                                <input type="hidden" name="icon" id="selectedIcon" value="" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-custom">Agregar Enlace</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Enlace -->
        <div class="modal fade" id="editLinkModal" tabindex="-1" aria-labelledby="editLinkModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg"> <!-- Tamaño adecuado para la selección de iconos -->
                <div class="modal-content">
                    <form id="editLinkForm" method="POST" action="{{ url_for('edit_link_ajax') }}" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="link_id" id="edit_link_id">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editLinkModalLabel">Editar Enlace</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campos del formulario con Validación en Tiempo Real -->
                            <div class="mb-3">
                                <label for="edit_title" class="form-label">Título <span class="text-danger">*</span></label>
                                <input type="text" name="title" id="edit_title" class="form-control" required>
                                <div class="invalid-feedback">
                                    Por favor, ingresa un título.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="edit_url" class="form-label">URL <span class="text-danger">*</span></label>
                                <input type="url" name="url" id="edit_url" class="form-control" required>
                                <div class="invalid-feedback">
                                    Por favor, ingresa una URL válida.
                                </div>
                            </div>
                            <!-- Selección de Icono -->
                            <div class="mb-3">
                                <label class="form-label">Selecciona un Icono <span class="text-danger">*</span></label>
                                <div class="row" id="editIconPicker">
                                    <!-- Iconos de FontAwesome -->
                                    {% for icon in [
                                        'fab fa-youtube', 'fab fa-twitter', 'fab fa-facebook', 'fab fa-instagram',
                                        'fab fa-linkedin', 'fab fa-snapchat', 'fab fa-whatsapp', 'fab fa-pinterest',
                                        'fab fa-reddit', 'fab fa-tiktok', 'fab fa-spotify', 'fab fa-discord',
                                        'fab fa-github', 'fab fa-stack-overflow', 'fab fa-apple', 'fab fa-android',
                                        'fab fa-aws', 'fab fa-dropbox', 'fab fa-paypal', 'fab fa-soundcloud'
                                    ] %}
                                    <div class="col-3 col-sm-2 mb-3">
                                        <button type="button" class="btn btn-light icon-btn" data-icon="{{ icon }}" title="{{ icon.split(' ')[1].replace('-', ' ') | capitalize }}">
                                            <i class="{{ icon }} fa-2x"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <!-- Campo Oculto para el Icono Seleccionado -->
                                <input type="hidden" name="icon" id="edit_selectedIcon" value="" required>
                                <!-- Mostrar Icono Seleccionado -->
                                <div id="edit_selectedIconDisplay" class="mt-3">
                                    <span class="me-2">Icono Seleccionado:</span>
                                    <i id="edit_displayedIcon" class=""></i>
                                    <div class="invalid-feedback">
                                        Por favor, selecciona un icono.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-custom">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para Cambiar Foto de Perfil -->
        <div class="modal fade" id="changeProfilePicModal" tabindex="-1" aria-labelledby="changeProfilePicModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="changeProfilePicForm" method="POST" enctype="multipart/form-data" action="{{ url_for('customize') }}" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="changeProfilePicModalLabel">Cambiar Foto de Perfil</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campo para subir nueva foto de perfil -->
                            <div class="mb-3">
                                <label for="profile_image" class="form-label">Nueva Foto de Perfil</label>
                                <input type="file" name="profile_image" id="profile_image" class="form-control" accept="image/*" required>
                                {% if current_user.profile_image %}
                                    <small class="form-text text-muted">Foto actual: {{ current_user.profile_image }}</small>
                                {% endif %}
                                <div class="invalid-feedback">
                                    Por favor, sube una imagen válida.
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Cambiar Foto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para Personalizar Fondo -->
        <div class="modal fade" id="customizeModal" tabindex="-1" aria-labelledby="customizeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="customizeForm" method="POST" enctype="multipart/form-data" action="{{ url_for('customize') }}" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="customizeModalLabel">Personalizar Fondo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campo para subir Imagen de Fondo -->
                            <div class="mb-3">
                                <label for="background_image" class="form-label">Imagen de Fondo</label>
                                <input type="file" name="background_image" id="background_image" class="form-control" accept="image/*">
                                {% if current_user.background_image %}
                                    <small class="form-text text-muted">Imagen actual: {{ current_user.background_image }}</small>
                                {% endif %}
                            </div>
                            <!-- Campo para subir Video de Fondo -->
                            <div class="mb-3">
                                <label for="background_video" class="form-label">Video de Fondo</label>
                                <input type="file" name="background_video" id="background_video" class="form-control" accept="video/*">
                                {% if current_user.background_video %}
                                    <small class="form-text text-muted">Video actual: {{ current_user.background_video }}</small>
                                {% endif %}
                            </div>
                            <!-- Opciones para elegir el tipo de fondo -->
                            <div class="mb-3">
                                <label for="background_type" class="form-label">Tipo de Fondo</label>
                                <select name="background_type" id="background_type" class="form-select" required>
                                    <option value="" disabled selected>Selecciona el tipo de fondo</option>
                                    <option value="image" {% if current_user.background_type == 'image' %}selected{% endif %}>Imagen</option>
                                    <option value="video" {% if current_user.background_type == 'video' %}selected{% endif %}>Video</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecciona el tipo de fondo.
                                </div>
                            </div>
                            <!-- Personalización de colores de los enlaces -->
                            <div class="mb-3">
                                <label for="link_color" class="form-label">Color de los Enlaces</label>
                                <input type="color" name="link_color" id="link_color" class="form-control form-control-color" value="{{ current_user.link_color or '#e94e1b' }}" title="Selecciona un color para los enlaces">
                                <small class="form-text text-muted">Elige un color para los botones de tus enlaces.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Biografía -->
        <div class="modal fade" id="editBioModal" tabindex="-1" aria-labelledby="editBioModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editBioForm" method="POST" enctype="multipart/form-data" action="{{ url_for('customize') }}" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editBioModalLabel">Editar Biografía</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campo para editar la biografía -->
                            <div class="mb-3">
                                <label for="bio" class="form-label">Biografía</label>
                                <textarea name="bio" id="bio" class="form-control" rows="4" placeholder="Escribe tu biografía aquí...">{{ current_user.bio }}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar Biografía</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Incluir Bootstrap JS, SortableJS y Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Scripts Personalizados Mejorados -->
<script>
    // Función global para eliminar enlaces
    function confirmDelete(linkId) {
        if(confirm('¿Estás seguro de eliminar este enlace?')) {
            var csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            fetch("{{ url_for('delete_link_ajax') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify({link_id: linkId})
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    location.reload();
                } else {
                    alert('Error al eliminar el enlace.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el enlace.');
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Definir las URLs de fondo
        var backgroundImageURL = "{{ url_for('static', filename='img/backgrounds/' ~ current_user.background_image) if current_user.background_image else '' }}";
        var backgroundVideoURL = "{{ url_for('static', filename='video/backgrounds/' ~ current_user.background_video) if current_user.background_video else '' }}";
        var linkColor = "{{ current_user.link_color or '#e94e1b' }}"; // Color de los enlaces

        // Aplicar el color de los enlaces al cargar la página
        applyLinkColor(linkColor);

        // Inicializar SortableJS para reordenar enlaces con Animaciones Suaves
        var sortable = new Sortable(document.getElementById('sortable'), {
            animation: 150,
            handle: '.handle',
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                // Obtener el nuevo orden de los enlaces
                var order = Array.from(document.querySelectorAll('#sortable .list-group-item')).map(function(item) {
                    return item.getAttribute('data-id');
                });
                var csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                // Enviar el nuevo orden al servidor
                fetch("{{ url_for('update_link_order') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf_token
                    },
                    body: JSON.stringify({order: order})
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        // Recargar el iframe para actualizar la previsualización
                        updatePhonePreview();
                        showToast('Orden actualizado exitosamente.', 'success');
                    } else {
                        showToast('Error al guardar el orden.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error al guardar el orden.', 'danger');
                });
            },
        });

        // Función para aplicar el color de los enlaces
        function applyLinkColor(color) {
            var linkButtons = document.querySelectorAll('.btn-success'); 
            linkButtons.forEach(function(button) {
                button.style.backgroundColor = color;
                button.style.borderColor = color;
            });
        }

        // Manejar el envío del formulario de agregar enlace con Validación en Tiempo Real
        document.getElementById('addLinkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            var formData = new FormData(this);
            var csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch("{{ url_for('add_link_ajax') }}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Cerrar el modal
                    var addModal = bootstrap.Modal.getInstance(document.getElementById('addLinkModal'));
                    addModal.hide();
                    // Recargar la página o actualizar la lista de enlaces
                    location.reload();
                } else {
                    showToast('Error al agregar el enlace.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error al agregar el enlace.', 'danger');
            });
        });

        // Manejar el envío del formulario de editar enlace con Validación en Tiempo Real
        document.getElementById('editLinkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            var formData = new FormData(this);
            var csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch("{{ url_for('edit_link_ajax') }}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Cerrar el modal
                    var editModal = bootstrap.Modal.getInstance(document.getElementById('editLinkModal'));
                    editModal.hide();
                    // Recargar la página o actualizar la lista de enlaces
                    location.reload();
                } else {
                    showToast('Error al actualizar el enlace.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error al actualizar el enlace.', 'danger');
            });
        });

        // Función para mostrar notificaciones con Animaciones Suaves
        function showToast(message, type) {
            var toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-white bg-' + type + ' border-0';
            toastEl.role = 'alert';
            toastEl.ariaLive = 'assertive';
            toastEl.ariaAtomic = 'true';
            toastEl.style.position = 'fixed';
            toastEl.style.top = '20px';
            toastEl.style.right = '20px';
            toastEl.style.zIndex = '1055';
            toastEl.classList.add('fade', 'show'); // Para animación de entrada

            var toastBody = document.createElement('div');
            toastBody.className = 'd-flex';
            toastBody.innerHTML = '<div class="toast-body">' + message + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>';

            toastEl.appendChild(toastBody);
            document.body.appendChild(toastEl);

            var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', function () {
                toastEl.remove();
            });
        }

        // Manejar clics en la navegación del sidebar con Animaciones Suaves
        document.querySelectorAll('#sidebarMenu .nav-link').forEach(function(element) {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                // Remover la clase 'active' de todos los enlaces
                document.querySelectorAll('#sidebarMenu .nav-link').forEach(function(el) {
                    el.classList.remove('active');
                });
                // Agregar la clase 'active' al enlace clicado
                this.classList.add('active');
                // Mostrar la sección correspondiente
                var section = this.getAttribute('data-section');
                showSection(section);
            });
        });

        // Función para mostrar la sección seleccionada con Transiciones Suaves
        function showSection(sectionId) {
            var sections = ['linktreeSection', 'analyticsSection'];
            sections.forEach(function(id) {
                var elem = document.getElementById(id);
                if(id === sectionId) {
                    elem.classList.remove('d-none');
                    elem.classList.add('fade', 'show'); // Añadir clases para transición
                } else {
                    elem.classList.add('d-none');
                    elem.classList.remove('fade', 'show');
                }
            });
        }

        // Función para actualizar el fondo dentro del teléfono
        function updatePhoneBackground(type) {
            var phoneBackgroundMedia = document.querySelector('.phone-background-media');
            var phoneLinks = document.querySelector('.linktree-iframe'); // Ajustado para iframe
            var screen = document.getElementById('phoneScreen');

            // Remover el fondo actual
            if(phoneBackgroundMedia) {
                phoneBackgroundMedia.remove();
            }

            if(type === 'image' && backgroundImageURL) {
                // Aplicar imagen de fondo
                var img = document.createElement('img');
                img.src = backgroundImageURL;
                img.alt = 'Background Image';
                img.className = 'phone-background-media';
                screen.insertBefore(img, phoneLinks);
            } else if(type === 'video' && backgroundVideoURL) {
                // Aplicar video de fondo
                var video = document.createElement('video');
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.className = 'phone-background-media';

                var source = document.createElement('source');
                source.src = backgroundVideoURL;
                source.type = 'video/mp4'; // Ajusta el tipo MIME según el formato de tu video

                video.appendChild(source);
                screen.insertBefore(video, phoneLinks);
            } else {
                // No aplicar fondo
                var placeholder = document.createElement('div');
                placeholder.className = 'phone-background-placeholder';
                screen.insertBefore(placeholder, phoneLinks);
            }
        }

        // Función para actualizar la previsualización en teléfono
        function updatePhonePreview() {
            var phoneLinks = document.querySelector('.linktree-iframe');
            if(phoneLinks) {
                phoneLinks.src = phoneLinks.src;
            }
        }

        // Inicializar el fondo al cargar la página y los gráficos de Analytics
        var selectedType = "{{ current_user.background_type }}" || 'image';
        updatePhoneBackground(selectedType);
        initializeCharts({{ analytics_data|tojson if analytics_data else 'null' }});
        updatePhonePreview();

        // Función para inicializar los gráficos de Analytics
        function initializeCharts(data) {
            if(!data) {
                console.error('No se recibieron datos de analytics.');
                return;
            }

            // Gráfico de Clics por Enlace Mejorado
            var ctxClicks = document.getElementById('clicksChart').getContext('2d');
            var clicksChart = new Chart(ctxClicks, {
                type: 'bar',
                data: {
                    labels: data.clicks_per_link.labels,
                    datasets: [{
                        label: 'Clics',
                        data: data.clicks_per_link.data,
                        backgroundColor: 'rgba(46, 204, 113, 0.6)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision:0
                            },
                            title: {
                                display: true,
                                text: 'Número de Clics'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Enlaces'
                            }
                        }
                    }
                }
            });

            // Gráfico de Enlaces Más Populares Mejorado
            var ctxPopular = document.getElementById('popularLinksChart').getContext('2d');
            var popularLinksChart = new Chart(ctxPopular, {
                type: 'doughnut',
                data: {
                    labels: data.popular_links.labels,
                    datasets: [{
                        data: data.popular_links.data,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.6)',
                            'rgba(231, 76, 60, 0.6)',
                            'rgba(46, 204, 113, 0.6)',
                            'rgba(155, 89, 182, 0.6)',
                            'rgba(241, 196, 15, 0.6)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            intersect: false,
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Nueva Gráfica de Tendencia de Clics a lo Largo del Tiempo con Líneas Individuales por Enlace
            var ctxTrend = document.getElementById('trendClicksChart').getContext('2d');
            var trendClicksChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: data.click_trend.labels, // Fechas o periodos
                    datasets: data.click_trend.datasets.map(function(dataset) {
                        return {
                            label: dataset.title,
                            data: dataset.data,
                            fill: false,
                            backgroundColor: dataset.color,
                            borderColor: dataset.color,
                            tension: 0.4
                        };
                    })
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Clics'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        }
                    }
                }
            });
        }

        // Función para manejar la selección de icono en los modales
        function setupIconSelectors(pickerId, hiddenInputId, displayIconId) {
            const iconButtons = document.querySelectorAll(`#${pickerId} .icon-btn`);
            const hiddenInput = document.getElementById(hiddenInputId);
            const displayedIcon = document.getElementById(displayIconId);

            iconButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Eliminar selección de otros botones
                    iconButtons.forEach(btn => btn.classList.remove('selected'));
                    // Añadir selección al botón actual
                    this.classList.add('selected');
                    // Obtener el icono seleccionado
                    const iconClass = this.getAttribute('data-icon');
                    // Actualizar el campo oculto y la vista previa
                    hiddenInput.value = iconClass;
                    displayedIcon.className = iconClass;
                });
            });
        }

        // Configurar los selectores de iconos en ambos modales
        setupIconSelectors('iconPicker', 'selectedIcon', 'displayedIcon');
        setupIconSelectors('editIconPicker', 'edit_selectedIcon', 'edit_displayedIcon');

        // Manejar la carga de datos en el Modal para Editar Enlace
        var editLinkModal = document.getElementById('editLinkModal');
        editLinkModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var linkId = button.getAttribute('data-link-id');
            var linkTitle = button.getAttribute('data-link-title');
            var linkUrl = button.getAttribute('data-link-url');
            var linkIcon = button.getAttribute('data-link-icon');

            var modal = this.querySelector('#editLinkForm');
            modal.querySelector('#edit_link_id').value = linkId;
            modal.querySelector('#edit_title').value = linkTitle;
            modal.querySelector('#edit_url').value = linkUrl;

            // Reset icon selection
            var editIconButtons = modal.querySelectorAll('#editIconPicker .icon-btn');
            editIconButtons.forEach(btn => btn.classList.remove('selected'));
            if(linkIcon){
                var selectedBtn = modal.querySelector(`.icon-btn[data-icon="${linkIcon}"]`);
                if(selectedBtn){
                    selectedBtn.classList.add('selected');
                }
                modal.querySelector('#edit_selectedIcon').value = linkIcon;
                modal.querySelector('#edit_displayedIcon').className = linkIcon;
            } else {
                modal.querySelector('#edit_selectedIcon').value = '';
                modal.querySelector('#edit_displayedIcon').className = '';
            }
        });

        // Validación de formularios Bootstrap
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')

            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }

                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    });
</script>

<!-- Estilos Personalizados -->
<style>
    /* Definir variables CSS dinámicas */
    :root {
        --primary-color: #e94e1b;
        --secondary-color: #34495e;
        --background-color: #f8f9fa;
        --text-color: #2c3e50;
        --link-color: {{ current_user.link_color or '#e94e1b' }};
        --hover-color: #50443b;
        --outline-primary-color: rgba(233, 78, 27, 0.1);
        --outline-secondary-color: rgba(52, 152, 219, 0.1);
        --outline-success-color: rgba(46, 204, 113, 0.1);
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Estilos para la foto de perfil en el sidebar */
    .profile-picture {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid var(--primary-color);
        transition: border-color 0.3s ease, transform 0.3s ease;
    }

    .profile-picture:hover {
        transform: scale(1.05);
    }

    /* Sidebar */
    .sidebar {
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding-top: 20px;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: var(--background-color);
        transition: background-color 0.3s ease;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar .nav-link {
        color: var(--text-color);
        transition: color 0.3s ease, background-color 0.3s ease;
    }

    .sidebar .nav-link:hover {
        background-color: var(--secondary-color);
        color: #fff !important;
        border-radius: 5px;
    }

    .sidebar .nav-link.active {
        background-color: var(--secondary-color);
        color: #fff !important;
        border-radius: 5px;
    }

    /* Sección de botones*/
    .btn.btn-dashboard {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .btn.btn-dashboard:hover {
        background-color: var(--hover-color);
        border-color: var(--hover-color);
    }


    /* Secciones de Contenido */
    #linktreeSection, #analyticsSection {
        padding-top: 20px;
        transition: opacity 0.5s ease;
    }

    .linktree-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Previsualización en Teléfono */
    .phone-preview {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
    }

    .phone {
        width: 300px;
        height: 600px;
        border: 16px var(--secondary-color) solid;
        border-radius: 36px;
        position: relative;
        background: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .phone::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 5px;
        background: #ccc;
        border-radius: 10px;
    }

    .screen {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        padding: 10px;
    }

    .phone-background-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
        transition: opacity 0.3s ease;
    }

    .phone-background-placeholder {
        width: 100%;
        height: 100%;
        background-color: #6c757d; /* Color de fondo predeterminado */
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
    }

    .phone-links {
        position: relative;
        z-index: 1;
    }

    .phone-links h4 {
        font-size: 1.2rem;
        color: var(--text-color);
    }

    .phone-links hr {
        border-top: 1px solid var(--text-color);
    }

    .phone-links .btn-link {
        margin-bottom: 10px;
        color: var(--link-color);
        font-size: 1rem;
        transition: color 0.3s ease;
    }

    .phone-links .btn-link:hover {
        color: var(--primary-color);
    }

    /* Selector de Iconos */
    .icon-btn {
        width: 100%;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .icon-btn:hover {
        background-color: #f1f1f1;
        transform: scale(1.05);
    }

    .icon-btn.selected {
        border-color: var(--primary-color);
        background-color: rgba(233, 78, 27, 0.1);
    }

    /* Animaciones Suaves para los Modales */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }
    .modal.show .modal-dialog {
        transform: translate(0, 0);
    }

    /* Validación de Formularios */
    .was-validated .form-control:invalid {
        border-color: #dc3545;
    }

    .was-validated .form-control:valid {
        border-color: #28a745;
    }

    /* Responsive Ajustes */
    @media (max-width: 768px) {
        .sidebar {
            position: static;
            height: auto;
            box-shadow: none;
        }
        .phone-preview {
            height: auto;
            margin-bottom: 20px;
        }
    }

    /* Estilos para las tarjetas de Analytics */
    .card-header {
        font-weight: bold;
        font-size: 1.1rem;
    }

    .card-body {
        position: relative;
        height: 300px; /* Ajusta según sea necesario */
    }

    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }

    /* Estilos para el tooltip de Chart.js */
    .chartjs-tooltip {
        opacity: 1;
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px;
        border-radius: 4px;
        pointer-events: none;
        transition: all .1s ease;
        transform: translate(-50%, 0);
        white-space: nowrap;
    }

    /* Estilos para botones de redes sociales */
    /* Botones de redes sociales con gradientes y efectos mejorados */
    .btn.btn-facebook {
        background: linear-gradient(45deg, #3b5998, #2d4373);
        color: #fff;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(59, 89, 152, 0.2);
    }

    .btn-facebook:hover {
        background: linear-gradient(45deg, #2d4373, #3b5998);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(59, 89, 152, 0.3);
    }

    .btn.btn-twitter {
        background: linear-gradient(45deg, #1DA1F2, #0d95e8);
        color: #fff;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(29, 161, 242, 0.2);
    }

    .btn-twitter:hover {
        background: linear-gradient(45deg, #0d95e8, #1DA1F2);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(29, 161, 242, 0.3);
    }

    .btn.btn-linkedin {
        background: linear-gradient(45deg, #0077b5, #005582);
        color: #fff;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 119, 181, 0.2);
    }

    .btn-linkedin:hover {
        background: linear-gradient(45deg, #005582, #0077b5);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 119, 181, 0.3);
    }

    .btn.btn-instagram {
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        color: #fff;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(225, 48, 108, 0.2);
    }

    .btn-instagram:hover {
        background: linear-gradient(45deg, #bc1888, #cc2366, #dc2743, #e6683c, #f09433);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(225, 48, 108, 0.3);
    }

    /* Estilo común para todos los botones de redes sociales */
    .btn.btn-facebook,
    .btn.btn-twitter,
    .btn.btn-linkedin,
    .btn.btn-instagram {
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: 500;
        font-size: 1.1rem;
    }

    /* YouTube */
    .fab.fa-youtube {
        color: #FF0000; /* Rojo de YouTube */
    }

    /* Snapchat */
    .fab.fa-snapchat {
        color: #FFFC00; /* Amarillo de Snapchat */
    }

    /* WhatsApp */
    .fab.fa-whatsapp {
        color: #25D366; /* Verde de WhatsApp */
    }

    /* Pinterest */
    .fab.fa-pinterest {
        color: #E60023; /* Rojo de Pinterest */
    }

    /* Reddit */
    .fab.fa-reddit {
        color: #FF4500; /* Naranja de Reddit */
    }

    /* TikTok */
    .fab.fa-tiktok {
        color: #69C9D0; /* Turquesa de TikTok */
    }

    /* Spotify */
    .fab.fa-spotify {
        color: #1DB954; /* Verde de Spotify */
    }

    /* Discord */
    .fab.fa-discord {
        color: #5865F2; /* Azul de Discord */
    }

    /* GitHub */
    .fab.fa-github {
        color: #333333; /* Gris de GitHub */
    }

    /* Stack Overflow */
    .fab.fa-stack-overflow {
        color: #F48024; /* Naranja de Stack Overflow */
    }

    /* Apple */
    .fab.fa-apple {
        color: #A2AAAD; /* Gris de Apple */
    }

    /* Android */
    .fab.fa-android {
        color: #3DDC84; /* Verde de Android */
    }

    /* AWS */
    .fab.fa-aws {
        color: #FF9900; /* Naranja de AWS */
    }

    /* Dropbox */
    .fab.fa-dropbox {
        color: #007EE5; /* Azul de Dropbox */
    }

    /* PayPal */
    .fab.fa-paypal {
        color: #003087; /* Azul Oscuro de PayPal */
    }

    /* SoundCloud */
    .fab.fa-soundcloud {
        color: #FF5500; /* Naranja de SoundCloud */
    }

    /* Efectos de hover para todos los iconos de Font Awesome */
    .fab {
        transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .fab:hover {
        transform: scale(1.1); /* Aumenta ligeramente el tamaño al pasar el cursor */
        opacity: 0.8;          /* Reduce la opacidad para un efecto de desvanecimiento */
    }
</style>
{% endblock %}
